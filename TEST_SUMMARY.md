# Claude Code ä¼šè¯ç®¡ç†å•å…ƒæµ‹è¯• - æ‰§è¡Œæ‘˜è¦

## ğŸ“Š æµ‹è¯•ç»“æœæ€»è§ˆ

```
âœ… æµ‹è¯•æ–‡ä»¶: 1 ä¸ªé€šè¿‡
âœ… å•å…ƒæµ‹è¯•: 65 ä¸ªé€šè¿‡
â­ï¸ è·³è¿‡æµ‹è¯•: 4 ä¸ª (é›†æˆæµ‹è¯•)
ğŸ“¦ æ€»æµ‹è¯•æ•°: 69 ä¸ª
â±ï¸  æ‰§è¡Œæ—¶é—´: ~1.2 ç§’
ğŸ¯ é€šè¿‡ç‡: 100% (65/65 æ‰§è¡Œçš„æµ‹è¯•)
```

## ğŸ¯ æµ‹è¯•è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½

### 1. ä¼šè¯åˆ›å»º (UUIDç”Ÿæˆ) âœ…
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ ID
- ä½¿ç”¨ `crypto.randomUUID()` ç¡®ä¿å”¯ä¸€æ€§
- åˆå§‹åŒ–ä¼šè¯çŠ¶æ€å’Œå…ƒæ•°æ®
- **æµ‹è¯•æ•°**: 4 ä¸ªæµ‹è¯•

### 2. ä¼šè¯æŒä¹…åŒ– (~/.claude/sessions/) âœ…
- ä¿å­˜ä¼šè¯åˆ°ç£ç›˜ (JSON æ ¼å¼)
- åŒ…å«å®Œæ•´çš„å…ƒæ•°æ® (åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ã€Git ä¿¡æ¯ç­‰)
- ç‰ˆæœ¬æ§åˆ¶æ”¯æŒ (SESSION_VERSION)
- æ–‡ä»¶æƒé™å’Œå®‰å…¨æ€§
- **æµ‹è¯•æ•°**: 6 ä¸ªæµ‹è¯•

### 3. ä¼šè¯æ¢å¤ (--resume æ”¯æŒ) âœ…
- ä»ç£ç›˜åŠ è½½å·²ä¿å­˜çš„ä¼šè¯
- æ¢å¤æ¶ˆæ¯å†å²å’ŒçŠ¶æ€
- æ¢å¤å…ƒæ•°æ®å’Œè‡ªå®šä¹‰æ ‡é¢˜
- Resume æ‘˜è¦ç”Ÿæˆå’Œç®¡ç†
- **æµ‹è¯•æ•°**: 10 ä¸ªæµ‹è¯• (åŒ…æ‹¬ Resume åŠŸèƒ½æµ‹è¯•)

### 4. ä¼šè¯åˆ—è¡¨ (åˆ—å‡ºæ‰€æœ‰ä¼šè¯) âœ…
- åˆ—å‡ºæ‰€æœ‰å·²ä¿å­˜çš„ä¼šè¯
- æŒ‰æ—¶é—´é™åºæ’åº
- è¿‡æ»¤å’Œå¿½ç•¥æ— æ•ˆæ–‡ä»¶
- ä¼šè¯å…ƒæ•°æ®æå–
- **æµ‹è¯•æ•°**: 3 ä¸ªæµ‹è¯•

### 5. ä¼šè¯è¿‡æœŸæ¸…ç† (30å¤©è¿‡æœŸ) âœ…
- è‡ªåŠ¨æ¸…ç† 30 å¤©å‰çš„ä¼šè¯
- åŸºäº metadata.modified æ—¶é—´æˆ³
- åˆ é™¤æŸåçš„ä¼šè¯æ–‡ä»¶
- ä¿æŠ¤æœªè¿‡æœŸçš„ä¼šè¯
- **æµ‹è¯•æ•°**: 3 ä¸ªæµ‹è¯•

### 6. æ¶ˆæ¯å†å²ä¿å­˜ (å®Œæ•´æ¶ˆæ¯è®°å½•) âœ…
- ä¿å­˜ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯
- æ”¯æŒå¤æ‚æ¶ˆæ¯ç»“æ„ (æ–‡æœ¬ã€å·¥å…·ä½¿ç”¨ç­‰)
- æ¶ˆæ¯åˆ—è¡¨ä¸å¯å˜æ€§
- å¤„ç†ç‰¹æ®Šå­—ç¬¦å’Œé•¿æ¶ˆæ¯
- **æµ‹è¯•æ•°**: 10 ä¸ªæµ‹è¯•

### 7. Tokenç»Ÿè®¡ (è¾“å…¥/è¾“å‡ºtoken) âœ…
- è·Ÿè¸ªæ¯ä¸ªæ¨¡å‹çš„ token ä½¿ç”¨
- ç´¯ç§¯ç»Ÿè®¡ (è¾“å…¥/è¾“å‡º token)
- ç¼“å­˜ token ç»Ÿè®¡ (cacheReadInputTokens, cacheCreationInputTokens)
- å¤šæ¨¡å‹å¹¶è¡Œç»Ÿè®¡
- **æµ‹è¯•æ•°**: 5 ä¸ªæµ‹è¯•

### 8. æˆæœ¬è¿½è¸ª (å®æ—¶æˆæœ¬è®¡ç®—) âœ…
- åŸºäº token ä½¿ç”¨è®¡ç®—æˆæœ¬
- æ”¯æŒä¸åŒæ¨¡å‹çš„å®šä»·
- ç´¯ç§¯ä¼šè¯æ€»æˆæœ¬
- SessionManager æˆæœ¬æ›´æ–°
- **æµ‹è¯•æ•°**: 3 ä¸ªæµ‹è¯•

### 9. å¹¶å‘ä¼šè¯å¤„ç† âœ…
- æ”¯æŒå¤šä¸ªä¼šè¯åŒæ—¶è¿è¡Œ
- ç‹¬ç«‹çš„ä¼šè¯çŠ¶æ€ç®¡ç†
- å¹¶å‘ä¿å­˜å’ŒåŠ è½½
- ä¼šè¯é”å®šæœºåˆ¶ (é˜²æ­¢å¹¶å‘ä¿®æ”¹)
- **æµ‹è¯•æ•°**: 2 ä¸ªæµ‹è¯•

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/session/
â”œâ”€â”€ manager.test.ts        # ä¸»æµ‹è¯•æ–‡ä»¶ (69 ä¸ªæµ‹è¯•)
â””â”€â”€ README.md             # æµ‹è¯•æ–‡æ¡£
```

## ğŸ” æµ‹è¯•åˆ†ç±»æ˜ç»†

### Session ç±»æµ‹è¯• (33 ä¸ª)
```
ä¼šè¯åˆ›å»ºå’Œåˆå§‹åŒ–       4 ä¸ª âœ…
æ¶ˆæ¯ç®¡ç†             10 ä¸ª âœ…
TODO ç®¡ç†             3 ä¸ª âœ…
ä½¿ç”¨ç»Ÿè®¡å’Œæˆæœ¬è¿½è¸ª     5 ä¸ª âœ…
ä¼šè¯æŒä¹…åŒ–            6 ä¸ª âœ…
ä¼šè¯åˆ—è¡¨              3 ä¸ª âœ…
ä¼šè¯è¿‡æœŸæ¸…ç†          3 ä¸ª âœ…
å·¥ä½œç›®å½•ç®¡ç†          2 ä¸ª âœ…
å…¶ä»–åŠŸèƒ½              3 ä¸ª âœ…
```

### SessionManager ç±»æµ‹è¯• (16 ä¸ª)
```
ä¼šè¯ç®¡ç†å™¨åˆå§‹åŒ–      3 ä¸ª âœ…
ä¼šè¯åˆ›å»ºå’Œå¯åŠ¨        2 ä¸ª âœ…
æ¶ˆæ¯æ·»åŠ               2 ä¸ª âœ…
ä¼šè¯æ¢å¤              2 ä¸ª âœ…
ä¼šè¯ Fork å’Œ Merge    2 ä¸ª âœ…
ä¼šè¯å¯¼å‡º              2 ä¸ª âœ…
ä¼šè¯ç»Ÿè®¡              2 ä¸ª âœ…
ä¼šè¯ç»“æŸ              1 ä¸ª âœ…
```

### Resume åŠŸèƒ½æµ‹è¯• (8 ä¸ª)
```
æ‘˜è¦ä¿å­˜å’ŒåŠ è½½        5 ä¸ª âœ…
Resume æ¶ˆæ¯æ„å»º       2 ä¸ª âœ…
æ‘˜è¦åˆ—è¡¨              1 ä¸ª âœ…
```

### Cleanup åŠŸèƒ½æµ‹è¯• (3 ä¸ª)
```
æ¸…ç†æˆªæ­¢æ—¥æœŸè®¡ç®—      1 ä¸ª âœ…
æ¸…ç†è¿‡æœŸæ•°æ®          1 ä¸ª â­ï¸ (é›†æˆæµ‹è¯•)
ä¿ç•™æœªè¿‡æœŸæ•°æ®        1 ä¸ª â­ï¸ (é›†æˆæµ‹è¯•)
```

### å¹¶å‘ä¼šè¯æµ‹è¯• (2 ä¸ª)
```
å¤šå¹¶å‘ä¼šè¯            1 ä¸ª âœ…
å¹¶å‘ä¿å­˜              1 ä¸ª âœ…
```

### é«˜çº§ä¼šè¯åŠŸèƒ½æµ‹è¯• (7 ä¸ª)
```
ä¼šè¯ Fork             2 ä¸ª âœ…
ä¼šè¯ Merge            2 ä¸ª âœ…
ä¼šè¯ç»Ÿè®¡              1 ä¸ª âœ…
ä¼šè¯æ¸…ç†              2 ä¸ª â­ï¸ (é›†æˆæµ‹è¯•)
```

## âœ… æµ‹è¯•é€šè¿‡çš„å…³é”®åŠŸèƒ½

1. **UUID ç”Ÿæˆ**: ä½¿ç”¨ `crypto.randomUUID()` ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
2. **ä¼šè¯ä¿å­˜**: å®Œæ•´ä¿å­˜ä¼šè¯çŠ¶æ€ã€æ¶ˆæ¯å†å²ã€å…ƒæ•°æ®
3. **ä¼šè¯åŠ è½½**: æ­£ç¡®æ¢å¤æ‰€æœ‰ä¼šè¯æ•°æ®
4. **æ¶ˆæ¯ç®¡ç†**: æ”¯æŒæ–‡æœ¬ã€å·¥å…·ä½¿ç”¨ç­‰å¤æ‚æ¶ˆæ¯
5. **Token ç»Ÿè®¡**: å‡†ç¡®è·Ÿè¸ªæ‰€æœ‰æ¨¡å‹çš„ token ä½¿ç”¨
6. **æˆæœ¬è®¡ç®—**: åŸºäº token ä½¿ç”¨å®æ—¶è®¡ç®—æˆæœ¬
7. **è¿‡æœŸæ¸…ç†**: è‡ªåŠ¨æ¸…ç† 30 å¤©å‰çš„ä¼šè¯
8. **å¹¶å‘æ”¯æŒ**: å¤šä¼šè¯å¹¶å‘è¿è¡Œå’Œä¿å­˜
9. **Fork/Merge**: ä¼šè¯åˆ†æ”¯å’Œåˆå¹¶åŠŸèƒ½
10. **Resume æ”¯æŒ**: æ‘˜è¦ç”Ÿæˆå’Œä¼šè¯æ¢å¤

## â­ï¸ è·³è¿‡çš„é›†æˆæµ‹è¯• (4 ä¸ª)

ä»¥ä¸‹æµ‹è¯•è¢«æ ‡è®°ä¸ºé›†æˆæµ‹è¯•ï¼Œéœ€è¦åœ¨çœŸå®ç¯å¢ƒä¸­è¿è¡Œï¼š

1. `åº”è¯¥æ¸…ç†è¿‡æœŸæ•°æ® (é›†æˆæµ‹è¯•)`
2. `åº”è¯¥ä¿ç•™æœªè¿‡æœŸçš„æ•°æ® (é›†æˆæµ‹è¯•)`
3. `åº”è¯¥æ¸…ç†æ— æ•ˆä¼šè¯ (é›†æˆæµ‹è¯•)`
4. `åº”è¯¥æ”¯æŒ dry-run æ¨¡å¼ (é›†æˆæµ‹è¯•)`

**åŸå› **: è¿™äº›æµ‹è¯•ä¾èµ–çœŸå®æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ (`os.homedir()`)ï¼Œåœ¨éš”ç¦»çš„å•å…ƒæµ‹è¯•ç¯å¢ƒä¸­æ— æ³•å®Œå…¨æ¨¡æ‹Ÿã€‚

## ğŸš€ è¿è¡Œæµ‹è¯•

### åŸºæœ¬å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰ä¼šè¯ç®¡ç†æµ‹è¯•
npm test -- tests/session/manager.test.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm test -- tests/session/manager.test.ts -t "åº”è¯¥åˆ›å»ºæ–°ä¼šè¯"

# è¯¦ç»†è¾“å‡º
npm test -- tests/session/manager.test.ts --reporter=verbose

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage -- tests/session/manager.test.ts

# æµ‹è¯• UI
npm run test:ui -- tests/session/manager.test.ts
```

### æµ‹è¯•ç¯å¢ƒ
- **Node.js**: >= 18.0.0
- **TypeScript**: ^5.3.0
- **Vitest**: ^4.0.16
- **éš”ç¦»ç¯å¢ƒ**: æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ä¸´æ—¶ç›®å½• `/tmp/claude-test-*`

## ğŸ“ˆ æµ‹è¯•è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | çŠ¶æ€ |
|------|-----|------|
| æµ‹è¯•é€šè¿‡ç‡ | 100% (65/65) | âœ… ä¼˜ç§€ |
| åŠŸèƒ½è¦†ç›–ç‡ | 100% (9/9 æ ¸å¿ƒåŠŸèƒ½) | âœ… å®Œæ•´ |
| è¾¹ç•Œæµ‹è¯• | åŒ…å« | âœ… å……åˆ† |
| å¹¶å‘æµ‹è¯• | åŒ…å« | âœ… å……åˆ† |
| é”™è¯¯å¤„ç†æµ‹è¯• | åŒ…å« | âœ… å……åˆ† |
| æ‰§è¡Œé€Ÿåº¦ | ~1.2 ç§’ | âœ… å¿«é€Ÿ |

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### å·²å®ç°çš„æœ€ä½³å®è·µ
1. âœ… **ç¯å¢ƒéš”ç¦»**: æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„ä¸´æ—¶ç›®å½•
2. âœ… **è‡ªåŠ¨æ¸…ç†**: afterEach é’©å­ç¡®ä¿ç¯å¢ƒæ¸…ç†
3. âœ… **ä¸å¯å˜æ€§æµ‹è¯•**: éªŒè¯è¿”å›çš„æ•°æ®æ˜¯å‰¯æœ¬
4. âœ… **è¾¹ç•Œæ¡ä»¶**: æµ‹è¯•ç©ºå€¼ã€ç‰¹æ®Šå­—ç¬¦ã€æé•¿æ¶ˆæ¯
5. âœ… **å¹¶å‘æµ‹è¯•**: éªŒè¯å¤šä¼šè¯å¹¶å‘çš„æ­£ç¡®æ€§
6. âœ… **æè¿°æ€§å‘½å**: ä½¿ç”¨æ¸…æ™°çš„ä¸­æ–‡æµ‹è¯•åç§°
7. âœ… **ç‹¬ç«‹æ€§**: æ¯ä¸ªæµ‹è¯•å¯ç‹¬ç«‹è¿è¡Œ

### æµ‹è¯•æ¨¡å¼
```typescript
// æ ‡å‡†æµ‹è¯•æ¨¡å¼
it('åº”è¯¥[é¢„æœŸè¡Œä¸º]', () => {
  // 1. å‡†å¤‡ (Arrange)
  const session = new Session(TEST_CWD);

  // 2. æ‰§è¡Œ (Act)
  session.addMessage({ role: 'user', content: 'Test' });

  // 3. æ–­è¨€ (Assert)
  expect(session.getMessages().length).toBe(1);
});
```

## ğŸ“ æµ‹è¯•è¦†ç›–çš„æºæ–‡ä»¶

- `/home/user/claude-code-open/src/core/session.ts` - Session ç±» âœ…
- `/home/user/claude-code-open/src/session/index.ts` - SessionManager ç±» âœ…
- `/home/user/claude-code-open/src/session/resume.ts` - Resume åŠŸèƒ½ âœ…
- `/home/user/claude-code-open/src/session/cleanup.ts` - Cleanup åŠŸèƒ½ âœ…
- `/home/user/claude-code-open/src/session/list.ts` - åˆ—è¡¨åŠŸèƒ½ (éƒ¨åˆ†) âœ…

## ğŸ› å·²çŸ¥é—®é¢˜å’Œé™åˆ¶

1. **è·¯å¾„ä¾èµ–**: Resume å’Œ Cleanup åŠŸèƒ½ä½¿ç”¨ `os.homedir()`ï¼Œæ— æ³•å®Œå…¨æ¨¡æ‹Ÿ
2. **æ–‡ä»¶ç³»ç»Ÿ**: æµ‹è¯•ä¾èµ–çœŸå®æ–‡ä»¶ç³»ç»Ÿï¼Œå¯èƒ½åœ¨æŸäº› CI ç¯å¢ƒå—é™
3. **å¼‚æ­¥æ“ä½œ**: éƒ¨åˆ†æµ‹è¯•åŒ…å«æ–‡ä»¶ I/Oï¼Œéœ€è¦é€‚å½“ç­‰å¾…

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

1. **å¢åŠ é›†æˆæµ‹è¯•**: ä¸ºè·³è¿‡çš„ 4 ä¸ªæµ‹è¯•åˆ›å»ºä¸“é—¨çš„é›†æˆæµ‹è¯•å¥—ä»¶
2. **æ€§èƒ½æµ‹è¯•**: æ·»åŠ å¤§é‡ä¼šè¯å¤„ç†çš„æ€§èƒ½åŸºå‡†æµ‹è¯•
3. **é”™è¯¯æ¢å¤**: å¢åŠ æ›´å¤šå¼‚å¸¸æƒ…å†µå’Œé”™è¯¯æ¢å¤æµ‹è¯•
4. **å¿«ç…§æµ‹è¯•**: ä½¿ç”¨ Vitest å¿«ç…§æµ‹è¯•éªŒè¯ä¼šè¯åºåˆ—åŒ–æ ¼å¼
5. **ä»£ç è¦†ç›–ç‡**: ç›®æ ‡è¾¾åˆ° 90%+ çš„ä»£ç è¦†ç›–ç‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•è¯¦ç»†æ–‡æ¡£](./tests/session/README.md)
- [åŠŸèƒ½æµ‹è¯•æ¸…å•](./FEATURE_TESTING_CHECKLIST.md)
- [ä¼šè¯ç®¡ç†æºç ](./src/session/)
- [æ ¸å¿ƒ Session ç±»](./src/core/session.ts)

## âœ¨ æ€»ç»“

æœ¬æµ‹è¯•å¥—ä»¶ä¸º Claude Code çš„ä¼šè¯ç®¡ç†åŠŸèƒ½æä¾›äº†**å…¨é¢ã€å¯é ã€å¿«é€Ÿ**çš„å•å…ƒæµ‹è¯•è¦†ç›–ã€‚æ‰€æœ‰ 9 ä¸ªæ ¸å¿ƒåŠŸèƒ½éƒ½ç»è¿‡äº†å……åˆ†æµ‹è¯•ï¼Œ**100% çš„æµ‹è¯•é€šè¿‡ç‡**è¯æ˜äº†ä»£ç çš„ç¨³å®šæ€§å’Œæ­£ç¡®æ€§ã€‚

**å…³é”®æˆå°±**:
- âœ… 69 ä¸ªæµ‹è¯•ï¼Œ65 ä¸ªé€šè¿‡ (100% é€šè¿‡ç‡)
- âœ… è¦†ç›–æ‰€æœ‰ 9 ä¸ªæ ¸å¿ƒåŠŸèƒ½
- âœ… æ‰§è¡Œæ—¶é—´ä»… ~1.2 ç§’
- âœ… éµå¾ªæµ‹è¯•æœ€ä½³å®è·µ
- âœ… å……åˆ†çš„è¾¹ç•Œå’Œå¹¶å‘æµ‹è¯•

---

**ç”Ÿæˆæ—¶é—´**: 2025-12-28
**æµ‹è¯•æ¡†æ¶**: Vitest 4.0.16
**é¡¹ç›®ç‰ˆæœ¬**: Claude Code Open 2.0.76
