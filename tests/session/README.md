# 会话管理单元测试文档

## 概述

本测试套件全面测试了 Claude Code 项目的会话管理功能，包括核心 Session 类、SessionManager 类以及相关的 Resume 和 Cleanup 功能。

## 测试文件

- **主测试文件**: `/home/user/claude-code-open/tests/session/manager.test.ts`
- **测试框架**: Vitest
- **总测试数**: 69 个测试
- **通过测试**: 65 个 ✅
- **跳过测试**: 4 个 ⏭️ (集成测试，需要真实文件系统)

## 测试覆盖范围

### 1. Session 类 (33 个测试)

#### 会话创建和初始化 (4 个测试)
- ✅ 创建新会话并生成 UUID
- ✅ 生成唯一的会话 ID
- ✅ 初始化空消息列表
- ✅ 初始化空 TODO 列表

#### 消息管理 (10 个测试)
- ✅ 添加用户消息
- ✅ 添加助手消息
- ✅ 添加包含工具使用的消息
- ✅ 清除所有消息
- ✅ 返回消息的副本（防止外部修改）
- ✅ 处理非常长的消息
- ✅ 处理包含多个块的消息
- ✅ 消息数组不可变性
- ✅ 支持复杂消息结构
- ✅ 处理特殊字符

#### TODO 管理 (3 个测试)
- ✅ 设置和获取 TODO 列表
- ✅ 返回 TODO 的副本
- ✅ 处理空 TODO 列表

#### 使用统计和成本追踪 (5 个测试)
- ✅ 更新使用统计
- ✅ 累积多次使用统计
- ✅ 跟踪多个模型的使用
- ✅ 跟踪缓存读取和创建 token
- ✅ 跟踪工具执行时间

#### 会话持久化 (6 个测试)
- ✅ 保存会话到文件
- ✅ 包含完整的元数据
- ✅ 加载保存的会话
- ✅ 加载不存在的会话返回 null
- ✅ 处理特殊字符的保存和加载
- ✅ 会话文件格式验证

#### 会话列表 (3 个测试)
- ✅ 列出所有会话
- ✅ 会话列表按时间降序排序
- ✅ 忽略无效的会话文件

#### 会话过期清理 (3 个测试)
- ✅ 清理过期的会话
- ✅ 保留未过期的会话
- ✅ 删除损坏的会话文件

#### 工作目录管理 (2 个测试)
- ✅ 设置工作目录
- ✅ 获取原始工作目录

#### 其他功能 (3 个测试)
- ✅ 设置自定义标题
- ✅ 获取第一条用户提示
- ✅ 当没有用户消息时返回 undefined

### 2. SessionManager 类 (16 个测试)

#### 会话管理器初始化 (3 个测试)
- ✅ 创建 SessionManager 实例
- ✅ 支持自动保存选项
- ✅ 支持禁用自动保存

#### 会话创建和启动 (2 个测试)
- ✅ 启动新会话
- ✅ 生成唯一的会话 ID

#### 消息添加 (2 个测试)
- ✅ 添加消息到当前会话
- ✅ 当没有当前会话时不应该抛出错误

#### 会话恢复 (2 个测试)
- ✅ 恢复已保存的会话
- ✅ 恢复不存在的会话返回 null

#### 会话 Fork 和 Merge (2 个测试)
- ✅ Fork 当前会话
- ✅ 合并会话

#### 会话导出 (2 个测试)
- ✅ 导出为 JSON 格式
- ✅ 导出为 Markdown 格式

#### 会话统计 (2 个测试)
- ✅ 返回会话摘要
- ✅ 计算成本

#### 会话结束 (1 个测试)
- ✅ 结束会话并清理

### 3. Resume 功能 (8 个测试)

- ✅ 保存摘要
- ✅ 加载摘要
- ✅ 加载不存在的摘要返回 null
- ✅ 检查摘要是否存在
- ✅ 删除摘要
- ✅ 构建 resume 消息
- ✅ 为非交互模式构建 resume 消息
- ✅ 列出所有摘要

### 4. Cleanup 功能 (3 个测试)

- ✅ 计算清理截止日期
- ⏭️ 清理过期数据 (集成测试)
- ⏭️ 保留未过期的数据 (集成测试)

### 5. 并发会话测试 (2 个测试)

- ✅ 支持多个并发会话
- ✅ 并发保存多个会话

### 6. 高级会话功能 (7 个测试)

#### 会话 Fork (2 个测试)
- ✅ Fork 会话并保持消息历史
- ✅ 从特定消息索引 fork

#### 会话 Merge (2 个测试)
- ✅ 合并两个会话
- ✅ 合并 token 使用统计

#### 会话统计 (1 个测试)
- ✅ 获取全局会话统计

#### 会话清理 (2 个测试)
- ⏭️ 清理无效会话 (集成测试)
- ⏭️ 支持 dry-run 模式 (集成测试)

## 测试结果摘要

```
Test Files  1 passed (1)
Tests       65 passed | 4 skipped (69)
Duration    1.12s
```

### 测试覆盖的功能点

根据 `FEATURE_TESTING_CHECKLIST.md`，以下功能已完全测试：

1. ✅ **会话创建** - UUID 生成和初始化
2. ✅ **会话持久化** - 保存到 ~/.claude/sessions/
3. ✅ **会话恢复** - --resume 支持
4. ✅ **会话列表** - 列出所有会话
5. ✅ **会话过期清理** - 30 天过期机制
6. ✅ **消息历史保存** - 完整消息记录
7. ✅ **Token 统计** - 输入/输出 token 跟踪
8. ✅ **成本追踪** - 实时成本计算
9. ✅ **并发会话处理** - 多会话同时运行

## 运行测试

### 运行所有会话测试
```bash
npm test -- tests/session/manager.test.ts
```

### 运行特定测试
```bash
npm test -- tests/session/manager.test.ts -t "应该创建新会话"
```

### 运行测试并生成覆盖率报告
```bash
npm run test:coverage -- tests/session/manager.test.ts
```

### 运行测试 UI
```bash
npm run test:ui -- tests/session/manager.test.ts
```

## 测试环境

- **Node.js**: >= 18.0.0
- **TypeScript**: ^5.3.0
- **Vitest**: ^4.0.16
- **测试目录**: 使用临时目录 `/tmp/claude-test-*`
- **环境隔离**: 每个测试都有独立的环境，测试后自动清理

## 跳过的集成测试

以下 4 个测试被标记为跳过，因为它们依赖真实文件系统路径和集成环境：

1. `应该清理过期数据 (集成测试)`
2. `应该保留未过期的数据 (集成测试)`
3. `应该清理无效会话 (集成测试)`
4. `应该支持 dry-run 模式 (集成测试)`

这些功能应该在集成测试环境中进行测试，使用：
```bash
npm run test:integration -- tests/integration/session-flow.test.ts
```

## 测试最佳实践

1. **环境隔离**: 每个测试使用独立的临时目录
2. **清理机制**: afterEach 钩子确保测试环境清理
3. **不可变性测试**: 验证返回的数据是副本，不是引用
4. **边界条件**: 测试空值、特殊字符、极长消息等
5. **并发测试**: 验证多会话并发运行的正确性

## 贡献指南

### 添加新测试

1. 在相应的 `describe` 块中添加测试
2. 使用描述性的测试名称（中文）
3. 确保测试独立且可重复运行
4. 使用 beforeEach/afterEach 进行清理

### 测试命名规范

- 使用中文描述测试目的
- 格式：`应该 + 动词 + 预期结果`
- 例如：`应该创建新会话并生成 UUID`

### 断言规范

- 使用 Vitest 的 expect API
- 优先使用语义化的断言：`toBe()`, `toEqual()`, `toBeDefined()`
- 为复杂断言添加错误消息

## 已知问题和限制

1. **路径依赖**: 某些功能（如 Resume 和 Cleanup）直接使用 `os.homedir()`，无法完全模拟
2. **文件系统**: 测试依赖真实文件系统操作，可能在某些 CI 环境中失败
3. **异步操作**: 部分测试包含异步操作，需要适当的等待机制

## 未来改进

1. 添加更多边界条件测试
2. 增加性能测试（大量会话处理）
3. 添加错误恢复测试
4. 实现完整的集成测试套件
5. 添加快照测试（snapshot testing）

## 相关文档

- [FEATURE_TESTING_CHECKLIST.md](/home/user/claude-code-open/FEATURE_TESTING_CHECKLIST.md)
- [会话管理源码](/home/user/claude-code-open/src/session/)
- [核心 Session 类](/home/user/claude-code-open/src/core/session.ts)
- [Vitest 文档](https://vitest.dev/)

## 联系方式

如有问题或建议，请提交 Issue 或 Pull Request。
